# ğŸš€ å†…å­˜ä¼˜åŒ–é…ç½®ï¼ˆRailway 512MB å…è´¹ç‰ˆï¼‰

## ğŸ“Š å½“å‰é…ç½®æ‘˜è¦

### æ ¸å¿ƒä¼˜åŒ–æŒ‡æ ‡
| é…ç½®é¡¹ | æ•°å€¼ | è¯´æ˜ |
|--------|------|------|
| **Node.js å†…å­˜é™åˆ¶** | 256MB | `--max-old-space-size=256` |
| **Chromium JS å †** | 256MB | `--js-flags=--max-old-space-size=256` |
| **è§†é¢‘ç¼“å­˜** | 32MB | `offthreadVideoCacheSizeInBytes` |
| **é»˜è®¤åˆ†è¾¨ç‡** | 20% (0.2) | `scale=0.2` |
| **é»˜è®¤ CRF** | 40 | æœ€ä½è´¨é‡ï¼Œæœ€å°å†…å­˜ |
| **å¹¶å‘æ•°** | 1 | å•çº¿ç¨‹æ¸²æŸ“ |

---

## ğŸ¯ æ€§èƒ½é¢„æœŸ

### æ”¯æŒçš„ç‰‡æ®µæ•°é‡
- **10+ ç‰‡æ®µ**: ä½¿ç”¨é»˜è®¤é…ç½® (`scale=0.2, crf=40`)
- **5-8 ç‰‡æ®µ**: ä½¿ç”¨ `scale=0.25, crf=38`
- **3-5 ç‰‡æ®µ**: ä½¿ç”¨ `scale=0.3, crf=35`

### æ¸²æŸ“æ—¶é—´ä¼°ç®—ï¼ˆRailway 512MBï¼‰
- **å•ä¸ªç‰‡æ®µ**: ~30-60 ç§’
- **10 ä¸ªç‰‡æ®µ**: ~5-10 åˆ†é’Ÿ
- **30 åˆ†é’Ÿè¶…æ—¶**: æ”¯æŒæœ€å¤š 20-30 ä¸ªç‰‡æ®µ

---

## âš™ï¸ è¯¦ç»†ä¼˜åŒ–æªæ–½

### 1ï¸âƒ£ Node.js å†…å­˜ä¼˜åŒ–
```bash
NODE_OPTIONS="--max-old-space-size=256 --max-semi-space-size=16"
```
- **max-old-space-size=256**: é™åˆ¶ Node.js å †å†…å­˜ä¸º 256MB
- **max-semi-space-size=16**: é™åˆ¶æ–°ç”Ÿä»£å†…å­˜ä¸º 16MB

### 2ï¸âƒ£ Chromium å†…å­˜ä¼˜åŒ–
```javascript
args: [
  '--no-sandbox',
  '--disable-setuid-sandbox',
  '--disable-dev-shm-usage',
  '--single-process',
  '--disable-gpu',
  '--js-flags=--max-old-space-size=256',  // Chromium JS å †é™åˆ¶
  '--disable-background-networking',
  '--disable-renderer-backgrounding',
  '--memory-pressure-off',
]
```

### 3ï¸âƒ£ Remotion æ¸²æŸ“ä¼˜åŒ–
```javascript
{
  concurrency: 1,  // å•çº¿ç¨‹æ¸²æŸ“
  offthreadVideoCacheSizeInBytes: 32 * 1024 * 1024,  // 32MB è§†é¢‘ç¼“å­˜
  scale: 0.2,  // 20% åˆ†è¾¨ç‡ï¼ˆ1920x1080 â†’ 384x216ï¼‰
  crf: 40,     // æœ€ä½è´¨é‡
}
```

---

## ğŸ“ ä½¿ç”¨å»ºè®®

### âœ… æ¨èåšæ³•
1. **å…ˆæµ‹è¯• 3 ä¸ªç‰‡æ®µ**ï¼Œç¡®è®¤å·¥ä½œæµæ­£å¸¸
2. **é€æ­¥å¢åŠ åˆ° 10 ä¸ªç‰‡æ®µ**
3. **ç›‘æ§å†…å­˜ä½¿ç”¨**: Railway ä¼šæ˜¾ç¤ºå†…å­˜å ç”¨ç™¾åˆ†æ¯”
4. **å¦‚æœ OOM**: è¿›ä¸€æ­¥é™ä½ `scale` åˆ° 0.15 æˆ– 0.1

### âš ï¸ æ³¨æ„äº‹é¡¹
1. **è§†é¢‘è´¨é‡è¾ƒä½**: `scale=0.2` æ„å‘³ç€åˆ†è¾¨ç‡åªæœ‰åŸæ¥çš„ 20%
2. **æ¸²æŸ“æ—¶é—´è¾ƒé•¿**: å•çº¿ç¨‹æ¸²æŸ“ï¼Œ30 ç§’è§†é¢‘å¯èƒ½éœ€è¦ 5-10 åˆ†é’Ÿ
3. **æ–‡ä»¶å¤§å°**: `crf=40` ä¼šç”Ÿæˆè¾ƒå°çš„è§†é¢‘æ–‡ä»¶ï¼ˆæœ‰æŸå‹ç¼©ï¼‰

### ğŸ”§ è°ƒä¼˜å‚æ•°

#### åœºæ™¯ 1: éœ€è¦æ›´é«˜è´¨é‡ï¼ˆé€‚åˆå°‘é‡ç‰‡æ®µï¼‰
```json
{
  "renderOptions": {
    "scale": 0.3,
    "crf": 35
  }
}
```

#### åœºæ™¯ 2: éœ€è¦æ¸²æŸ“æ›´å¤šç‰‡æ®µï¼ˆç‰ºç‰²è´¨é‡ï¼‰
```json
{
  "renderOptions": {
    "scale": 0.15,
    "crf": 45
  }
}
```

#### åœºæ™¯ 3: æé™æµ‹è¯•ï¼ˆæœ€å¤šç‰‡æ®µï¼‰
```json
{
  "renderOptions": {
    "scale": 0.1,
    "crf": 51
  }
}
```

---

## ğŸ§ª æµ‹è¯•æµç¨‹

### æ­¥éª¤ 1: å¯åŠ¨æœåŠ¡
```bash
# æœ¬åœ°æµ‹è¯•
npm install
npm start

# Docker æµ‹è¯•
docker build -t remotion-server .
docker run -p 3000:3000 remotion-server
```

### æ­¥éª¤ 2: æäº¤æ¸²æŸ“ä»»åŠ¡
```bash
curl -X POST http://localhost:3000/render \
  -H "Content-Type: application/json" \
  -d @test-10-segments.json
```

### æ­¥éª¤ 3: æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
```bash
curl http://localhost:3000/render/{taskId}
```

### æ­¥éª¤ 4: ä¸‹è½½è§†é¢‘
```bash
curl -O http://localhost:3000/output/test-10-segments.mp4
```

---

## ğŸ“ˆ å†…å­˜ä½¿ç”¨ç›‘æ§

### Railway å¹³å°
- è®¿é—® Railway Dashboard
- æŸ¥çœ‹ **Metrics** â†’ **Memory Usage**
- æ­£å¸¸åº”ä¿æŒåœ¨ **400-480MB** ä»¥ä¸‹

### æœ¬åœ°ç›‘æ§
```bash
# å®æ—¶ç›‘æ§å†…å­˜
docker stats

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs -f <container-id>
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ¸²æŸ“å¤±è´¥ (OOM)
**åŸå› **: å†…å­˜ä¸è¶³  
**è§£å†³æ–¹æ¡ˆ**:
1. é™ä½ `scale` åˆ° 0.15 æˆ– 0.1
2. å¢åŠ  `crf` åˆ° 45 æˆ– 51
3. å‡å°‘ç‰‡æ®µæ•°é‡

### é—®é¢˜ 2: æ¸²æŸ“è¶…æ—¶
**åŸå› **: ç‰‡æ®µè¿‡å¤šæˆ–è§†é¢‘è¿‡é•¿  
**è§£å†³æ–¹æ¡ˆ**:
1. æ‹†åˆ†ä¸ºå¤šä¸ªå°ä»»åŠ¡
2. å¢åŠ  `timeoutInMilliseconds` é…ç½®
3. ä½¿ç”¨ Railway Pro ç‰ˆï¼ˆæ›´å¤šèµ„æºï¼‰

### é—®é¢˜ 3: è§†é¢‘è´¨é‡å¤ªå·®
**åŸå› **: `scale` å’Œ `crf` è®¾ç½®è¿‡ä½  
**è§£å†³æ–¹æ¡ˆ**:
1. æé«˜ `scale` åˆ° 0.25 æˆ– 0.3
2. é™ä½ `crf` åˆ° 35 æˆ– 32
3. å‡çº§åˆ° 1GB+ å†…å­˜çš„æœåŠ¡å™¨

---

## ğŸ‰ æˆåŠŸæ¡ˆä¾‹

### é…ç½® A: Railway å…è´¹ç‰ˆ (512MB)
- **ç‰‡æ®µæ•°**: 10 ä¸ª
- **åˆ†è¾¨ç‡**: 384x216 (scale=0.2)
- **CRF**: 40
- **æ¸²æŸ“æ—¶é—´**: ~8 åˆ†é’Ÿ
- **å†…å­˜å³°å€¼**: ~450MB
- **âœ… æˆåŠŸæ¸²æŸ“**

### é…ç½® B: Railway Pro (2GB)
- **ç‰‡æ®µæ•°**: 30 ä¸ª
- **åˆ†è¾¨ç‡**: 768x432 (scale=0.4)
- **CRF**: 32
- **æ¸²æŸ“æ—¶é—´**: ~15 åˆ†é’Ÿ
- **å†…å­˜å³°å€¼**: ~1.5GB
- **âœ… æˆåŠŸæ¸²æŸ“**

---

## ğŸ“š ç›¸å…³èµ„æº

- [Railway æ–‡æ¡£](https://docs.railway.app/)
- [Remotion æ–‡æ¡£](https://www.remotion.dev/docs)
- [FFmpeg CRF æŒ‡å—](https://trac.ffmpeg.org/wiki/Encode/H.264#crf)
- [Chromium å¯åŠ¨å‚æ•°](https://peter.sh/experiments/chromium-command-line-switches/)

---

**æœ€åæ›´æ–°**: 2025-10-26  
**ç›®æ ‡**: æ”¯æŒ Railway å…è´¹ç‰ˆ 512MB æ¸²æŸ“ 10+ ç‰‡æ®µè§†é¢‘

