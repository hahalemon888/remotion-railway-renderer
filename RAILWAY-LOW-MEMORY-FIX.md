# 🚨 Railway 低内存问题解决方案

## 问题诊断

你遇到的 **SIGKILL 错误** 是因为：
- Railway 免费套餐只有 **512MB RAM**
- 渲染 1920x1080 视频需要 **~800MB+** 内存
- 系统在内存不足时会强制杀死进程

## ✅ 解决方案已部署

我已经添加了 **分辨率缩放** 功能，现在默认使用 **50% 分辨率** 渲染，可以在 512MB 内存下成功运行！

---

## 🎯 立即测试（使用默认低内存模式）

### 1. 等待 Railway 重新部署
- 访问你的 Railway 仪表板
- 等待 3-5 分钟让新代码部署完成

### 2. 在 n8n 中测试

**重要**: 现在 API 会 **自动使用低内存模式**（50% 分辨率），你不需要修改任何东西！

只需在 n8n 中重新运行你的工作流，它会：
- 自动将 1920x1080 缩放到 960x540
- 使用优化的编码参数
- 内存使用降低到 ~200MB

### 3. 检查结果

渲染完成后，你会看到：
```json
{
  "status": "completed",
  "data": {
    "width": 960,
    "height": 540,
    "originalWidth": 1920,
    "originalHeight": 1080,
    "scale": 0.5,
    "downloadUrl": "/output/xxx.mp4"
  }
}
```

---

## 🔧 自定义分辨率（可选）

如果你想要更高的质量（需要升级 Railway 套餐），可以在 n8n 的 "提交渲染任务" 节点中添加：

### 在 Lark Base 节点后添加 "Set" 节点

添加一个 **Set** 节点来设置渲染选项：

**节点配置**:
```json
{
  "values": {
    "renderOptions": {
      "scale": 0.5,
      "crf": 30
    }
  },
  "options": {
    "dotNotation": true
  }
}
```

### 或者直接在 HTTP Request 节点中添加

在 "提交渲染任务" 的 Body Parameters 中添加：

| Name | Value |
|------|-------|
| `renderOptions` | `{{ { "scale": 0.5, "crf": 30 } }}` |

---

## 📊 分辨率选项对比

| scale 值 | 输出分辨率 | 内存使用 | Railway 免费套餐 | 质量 |
|---------|-----------|---------|-----------------|------|
| `0.5` ⭐ | 960x540 | ~200MB | ✅ 可用 | 可接受 |
| `0.75` | 1440x810 | ~400MB | ⚠️ 边缘 | 良好 |
| `1.0` | 1920x1080 | ~800MB | ❌ 失败 | 优秀 |

**推荐**: 在免费套餐上使用 `scale: 0.5`（默认）

---

## 🧪 测试步骤

### 步骤 1: 确认部署完成

访问你的 Railway 应用：
```
https://your-app.railway.app/
```

你应该看到：
```json
{
  "name": "Remotion Railway Renderer API (异步模式 + 内存优化)",
  "version": "2.1.0",
  "renderOptions": {
    "scale": "分辨率缩放比例 (0.1-1.0)，默认 0.5 (50%)，用于节省内存",
    ...
  }
}
```

### 步骤 2: 在 n8n 中测试

1. 打开你的 n8n 工作流
2. 点击 "Execute Workflow"
3. 等待渲染完成（应该不会再出现 SIGKILL 错误）

### 步骤 3: 检查视频

下载渲染好的视频，检查：
- ✅ 分辨率是 960x540
- ✅ 视频可以正常播放
- ✅ 质量可接受（虽然不是全高清）

---

## 🚀 如果你需要更高质量

### 选项 1: 升级 Railway 套餐（推荐）

**Railway Hobby Plan** - $5/月
- 8GB RAM
- 可以渲染 1080p 视频
- 设置 `scale: 0.75` 或 `scale: 1.0`

### 选项 2: 使用其他平台

- **Render.com**: 免费套餐提供 512MB，但性能更好
- **Fly.io**: 更灵活的内存配置
- **自己的 VPS**: 完全控制

---

## 📝 完整的 n8n 配置示例

如果你想手动控制分辨率，这是完整的配置：

### HTTP Request 节点 - "提交渲染任务"

**URL**: `https://your-app.railway.app/render`  
**Method**: `POST`  
**Body Parameters**:

```json
{
  "compositionId": "{{ $json.compositionId || 'MyVideo' }}",
  "inputProps": "{{ $json.inputProps }}",
  "outputFileName": "{{ $json.outputFileName || 'video-' + Date.now() + '.mp4' }}",
  "renderOptions": {
    "scale": 0.5,
    "crf": 30
  }
}
```

---

## 🐛 故障排除

### 问题: 仍然出现 SIGKILL

**解决方案**:
1. 降低到 `scale: 0.4` 或 `scale: 0.3`
2. 提高 `crf` 到 `32` 或 `35`
3. 检查视频时长（建议 ≤ 30 秒）

### 问题: 视频质量太差

**解决方案**:
- 这是免费套餐的限制
- 考虑升级到 Hobby Plan ($5/月)
- 或者使用其他渲染服务

### 问题: 渲染时间变长了

**说明**:
- 这是正常的，因为我们使用了内存优化
- 通常增加 20-30% 的渲染时间
- 但可以避免 SIGKILL 错误

---

## 📞 下一步

1. **立即测试**: 在 n8n 中重新运行工作流
2. **检查结果**: 应该不会再出现 SIGKILL 错误
3. **评估质量**: 如果 960x540 可以接受，就继续使用
4. **考虑升级**: 如果需要 1080p，升级到 Hobby Plan

---

## 💡 关键要点

- ✅ **默认配置已优化**: 不需要修改任何东西就能在免费套餐上运行
- ✅ **自动缩放**: 1920x1080 → 960x540
- ✅ **内存使用**: ~200MB（远低于 512MB 限制）
- ⚠️ **质量权衡**: 分辨率降低，但可以成功渲染
- 🚀 **升级选项**: $5/月可以获得 1080p 渲染能力

**现在就去测试吧！应该可以成功渲染了！** 🎉

