# ⏱️ 超时优化说明

## 📊 问题分析

### 原始问题
- **错误**: `delayRender() was called but not cleared after 118000ms`
- **原因**: 火山引擎视频 URL 加载速度极慢
- **数据**: 3个视频片段加载用时 **118秒**（约 40秒/片段）

---

## 🎯 优化方案

### 超时时间设置

#### 计算依据
```
场景: 10-15 个视频片段，每个 5-10 秒
加载时间: 15 片段 × 40秒/片段 = 600秒
安全余量: +300秒
最终设置: 900秒（15分钟）
```

#### 修改位置

1. **服务器端渲染超时** (`server/index.js`)
```javascript
timeoutInMilliseconds: 900000,  // 900秒超时（15分钟）
```

2. **前端组件超时** (`src/ComplexVideo.tsx`)
   - OffthreadVideo（背景视频）: `900000ms`
   - Img（背景图片）: `900000ms`
   - Audio（片段音频）: `900000ms`
   - Audio（背景音乐）: `900000ms`

---

## 📈 性能预期

### 不同片段数量的预期加载时间

| 片段数 | 预期加载时间 | 超时设置 | 余量 |
|--------|-------------|---------|------|
| 3 片段  | ~2 分钟     | 15 分钟 | 13 分钟 |
| 5 片段  | ~3.5 分钟   | 15 分钟 | 11.5 分钟 |
| 10 片段 | ~7 分钟     | 15 分钟 | 8 分钟 |
| 15 片段 | ~10 分钟    | 15 分钟 | 5 分钟 |

---

## 🚀 使用建议

### 1. 监控渲染进度
```bash
# 查询任务状态
curl http://localhost:3000/status/{taskId}
```

### 2. 如果仍然超时
考虑以下优化：
- ✅ 使用 CDN 加速视频加载
- ✅ 预下载视频到本地
- ✅ 使用更快的视频托管服务
- ✅ 减少视频分辨率

### 3. 调整超时时间
如果需要处理更多片段（>15个），可以按以下公式调整：

```javascript
// 计算公式
const timeoutMs = (片段数量 × 40000) + 300000;

// 例如 20 个片段
const timeoutMs = (20 × 40000) + 300000 = 1100000; // 18.3 分钟
```

---

## ⚠️ 注意事项

1. **内存限制**: 当前设置为 50% 分辨率以节省内存
2. **并发限制**: 单线程渲染（`concurrency: 1`）
3. **网络依赖**: 加载时间完全取决于火山引擎的响应速度

---

## 🔧 故障排除

### 如果遇到超时错误
1. 检查网络连接
2. 验证视频 URL 是否有效
3. 考虑增加超时时间
4. 查看服务器日志获取详细信息

### 如果渲染卡住
1. 检查任务状态: `GET /status/{taskId}`
2. 查看服务器日志
3. 重启服务器: `npm run server`

---

## 📝 更新日志

### 2025-10-25
- ✅ 将超时从 120秒 增加到 900秒（15分钟）
- ✅ 支持 10-15 个视频片段的渲染
- ✅ 统一所有组件的超时设置
- ✅ 添加详细的计算依据和文档

---

## 🎬 测试建议

### 测试用例
1. **小规模测试**: 3-5 个片段
2. **中等规模**: 8-10 个片段
3. **大规模测试**: 12-15 个片段

### 监控指标
- 总加载时间
- 单个片段加载时间
- 渲染成功率
- 内存使用情况

---

**当前配置已优化完成，可以支持 10-15 个视频片段的渲染！** ✨

