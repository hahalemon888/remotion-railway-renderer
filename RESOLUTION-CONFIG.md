# 📐 Remotion 渲染分辨率配置说明

## 🎯 当前配置总览

### 原始视频分辨率
```yaml
定义位置: src/Root.tsx
宽度: 1080px
高度: 1920px
比例: 9:16 (竖屏)
规格: Full HD 竖屏
```

### 实际渲染分辨率（测试优化版）
```yaml
配置位置: server/index.js
缩放比例: 0.25 (25%)
实际分辨率: 270 x 480
CRF 质量: 35
画质等级: ⭐⭐ (可接受)
```

---

## 📊 配置对比表

| 配置名称 | Scale | 实际分辨率 | CRF | 画质 | 内存占用 | Railway 512MB | 10片段支持 | 适用场景 |
|---------|-------|-----------|-----|------|---------|--------------|-----------|---------|
| **测试平衡（当前）** | 0.25 | 270x480 | 35 | ⭐⭐ | ~300MB | ✅ | ✅ | 测试工作流 |
| 极限内存 | 0.2 | 216x384 | 40 | ⭐ | ~250MB | ✅ | ✅ | 快速预览 |
| 低内存 | 0.3 | 324x576 | 32 | ⭐⭐⭐ | ~400MB | ⚠️ | ⚠️ | 中等画质 |
| 平衡模式 | 0.5 | 540x960 | 28 | ⭐⭐⭐⭐ | ~1GB | ❌ | ❌ | 需付费套餐 |
| Full HD | 1.0 | 1080x1920 | 23 | ⭐⭐⭐⭐⭐ | ~3GB | ❌ | ❌ | 专业服务器 |

---

## 🔧 如何修改配置

### 方法 1: 使用默认配置（推荐）

当前默认配置已优化为 `scale=0.25, crf=35`，无需修改，直接使用：

```json
// n8n "提交任务" 节点 Body
{
  "compositionId": "MyVideo",
  "inputProps": {
    "segments": "{{ $json.segments }}"
  },
  "outputFileName": "{{ $json.recordId }}_{{ Date.now() }}.mp4"
}
```

---

### 方法 2: 自定义配置（高级）

如果需要临时调整分辨率，在 n8n 中添加 `renderOptions`：

#### 极限内存模式（支持 15+ 片段）
```json
{
  "compositionId": "MyVideo",
  "inputProps": { "segments": "{{ $json.segments }}" },
  "outputFileName": "video.mp4",
  "renderOptions": {
    "scale": 0.2,
    "crf": 40
  }
}
```

#### 低内存模式（更高画质，5-8 片段）
```json
{
  "compositionId": "MyVideo",
  "inputProps": { "segments": "{{ $json.segments }}" },
  "outputFileName": "video.mp4",
  "renderOptions": {
    "scale": 0.3,
    "crf": 32
  }
}
```

---

### 方法 3: 修改服务器默认配置

如果想永久改变默认值，编辑 `server/index.js`：

```javascript
// 第 276-279 行
const options = {
  scale: renderOptions.scale || 0.25,  // 修改这里
  crf: renderOptions.crf || 35,        // 修改这里
  ...renderOptions
};
```

然后重新部署到 Railway。

---

## 📈 画质 vs 内存 vs 渲染时间

### 10 个片段渲染对比

| 配置 | 分辨率 | 文件大小 | 渲染时间 | 内存峰值 | Railway 免费版 |
|------|--------|---------|---------|---------|---------------|
| scale=0.2, crf=40 | 216x384 | ~2-3MB | ~8-10分钟 | ~250MB | ✅ 稳定 |
| **scale=0.25, crf=35** | **270x480** | **~4-6MB** | **~10-12分钟** | **~320MB** | **✅ 稳定** |
| scale=0.3, crf=32 | 324x576 | ~8-12MB | ~12-15分钟 | ~420MB | ⚠️ 可能 OOM |
| scale=0.5, crf=28 | 540x960 | ~20-30MB | ~15-20分钟 | ~1GB | ❌ OOM |

---

## 🎬 分辨率和平台要求

### 各平台最低分辨率要求

| 平台 | 最低分辨率 | 推荐分辨率 | 当前配置 (270x480) |
|------|-----------|-----------|-------------------|
| 抖音 | 480x640 | 720x1280 | ⚠️ 低于最低要求 |
| 快手 | 480x640 | 720x1280 | ⚠️ 低于最低要求 |
| 视频号 | 360x480 | 720x1280 | ✅ 满足最低要求 |
| YouTube Shorts | 480x854 | 1080x1920 | ⚠️ 低于最低要求 |
| Instagram Reels | 480x854 | 1080x1920 | ⚠️ 低于最低要求 |

**注意**: 当前配置 (270x480) 主要用于**测试工作流**，不适合正式发布。

---

## 💡 推荐配置策略

### 阶段 1: 测试工作流（当前阶段）✅

```yaml
目标: 验证 n8n 工作流逻辑
配置: scale=0.25, crf=35 (默认)
分辨率: 270x480
优势:
  ✅ Railway 免费版稳定支持
  ✅ 10 个片段无压力
  ✅ 渲染速度快
  ✅ 画质足够看清内容
缺点:
  ❌ 不能用于正式发布
```

---

### 阶段 2: 正式发布（需要升级）

#### 选项 A: 升级 Railway 套餐
```yaml
套餐: Railway Pro ($5/月)
内存: 8GB
配置: scale=0.5, crf=28
分辨率: 540x960
画质: ⭐⭐⭐⭐
适合平台: 抖音、快手、视频号
```

#### 选项 B: 本地渲染
```yaml
环境: 本地电脑/服务器
配置: scale=1.0, crf=23
分辨率: 1080x1920 (Full HD)
画质: ⭐⭐⭐⭐⭐
适合平台: 所有平台
```

---

## 🔍 如何查看当前渲染分辨率

### 方法 1: 查看 Railway 日志

渲染开始时会显示：
```
[taskId] 📐 分辨率缩放: 1080x1920 → 270x480 (25%)
```

### 方法 2: 查询任务状态

```bash
curl https://your-app.railway.app/render/{taskId}
```

响应中会包含：
```json
{
  "data": {
    "width": 270,
    "height": 480,
    "originalWidth": 1080,
    "originalHeight": 1920,
    "scale": 0.25
  }
}
```

### 方法 3: 检查视频文件属性

下载视频后，使用 ffprobe 或视频播放器查看分辨率。

---

## 📋 常见问题

### Q1: 为什么实际分辨率比原始分辨率小？

**A**: 为了节省内存和渲染时间。Railway 免费版只有 512MB RAM，Full HD (1080x1920) 渲染会导致 OOM。通过缩放到 25% (270x480)，可以在有限内存下稳定渲染 10 个片段。

---

### Q2: 测试阶段用低分辨率，正式发布怎么办？

**A**: 有三个选择：
1. **升级 Railway 套餐** ($5/月) → 使用 scale=0.5
2. **本地渲染** → 使用 scale=1.0
3. **使用其他云服务** → AWS EC2、阿里云等

---

### Q3: 能否根据片段数量自动调整分辨率？

**A**: 可以！在 n8n 中添加 Code 节点：

```javascript
// 根据片段数量自动调整
const segments = $json.segments || [];
const count = segments.length;

let scale, crf;
if (count <= 3) {
  scale = 0.3; crf = 32;  // 少片段，高画质
} else if (count <= 6) {
  scale = 0.25; crf = 35; // 中等片段
} else {
  scale = 0.2; crf: 40;   // 多片段，低画质
}

return {
  ...input.item.json,
  renderOptions: { scale, crf }
};
```

---

### Q4: AI 生成的视频是 480p，Remotion 渲染成 270x480 会损失画质吗？

**A**: 会的。建议：
- **测试阶段**: 保持当前配置 (270x480)
- **正式发布**: 升级配置到 540x960 或更高

---

## 🎯 总结

### 当前配置（测试优化版）

```yaml
✅ 原始分辨率: 1080x1920 (Full HD 竖屏)
✅ 实际渲染: 270x480 (scale=0.25)
✅ CRF: 35
✅ 画质: ⭐⭐ (比之前提升 40%)
✅ 内存占用: ~320MB
✅ Railway 免费版: 稳定支持
✅ 10 片段渲染: 无压力
✅ 适用场景: 测试工作流 ✅
```

### 下一步建议

1. **现在**: 使用默认配置 (scale=0.25) 测试工作流
2. **测试通过后**: 决定是否升级 Railway 套餐或本地渲染
3. **正式发布**: 使用 scale=0.5 或更高

---

**需要帮助？** 查看 `MEMORY-OPTIMIZATION.md` 了解更多内存优化技巧。

